<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<h3>第一步:選定股票</h3>
<label for="stockid">股票代號</label>
<input type="text" id="stockid" name="SnCode" onchange="stockinput()">
<br>
<br>

<div style="display: flex;">
	<label>股票名稱:</label>
	<div id="stockname"></div>
</div>
<h3>第二步:選定投資偏好及選擇模型</h3>
<div style="display: flex;">
	投資偏好:
	<button id="longterm">長期</button>
	<button id="shortterm">短期</button>
</div>
<label>選擇模型(灰底請選擇一個):</label>
<select id="selectmodel" multiple>
	<option value="1">LSTM</option>
	<option value="2">FNN</option>
	<option value="3">迴歸</option>
	<option value="4">時間序列</option>
</select>
<button id="checkmodel">確認模型</button>

<br>
<br>


<div id="borisform1">
	<h3>第三步:設定參數並建置模型預測</h3>
	<h4>參數選擇:</h4>
	<h5>技術面:</h5>
	<input type="checkbox" id="borisparam1" name="SteOpen">
	<label for="borisparam1">開盤價</label>
	<input type="checkbox" id="borisparam2" name="SteClose">
	<label for="borisparam2">收盤價</label>
	<input type="checkbox" id="borisparam3" name="SteMax">
	<label for="borisparam3">最高價</label>
	<input type="checkbox" id="borisparam4" name="SteMin">
	<label for="borisparam4">最低價</label>
	<input type="checkbox" id="borisparam5" name="SteSpreadRatio">
	<label for="borisparam5">震幅</label>
	<input type="checkbox" id="borisparam6" name="SteTradeMoney">
	<label for="borisparam6">當日交易額</label>
	<input type="checkbox" id="borisparam7" name="SteTradeQuantity">
	<label for="borisparam7">當日交易量</label>
	<input type="checkbox" id="borisparam8" name="SteTransActions">
	<label for="borisparam8">當日交易比數</label>
	<input type="checkbox" id="borisparam9" name="SiMovingAverage5">
	<label for="borisparam9">移動平均_5天</label>
	<input type="checkbox" id="borisparam10" name="SiMovingAverage30">
	<label for="borisparam10">移動平均_30天</label>
	<input type="checkbox" id="borisparam11" name="SiRsv5">
	<label for="borisparam11">RSV_5天</label>
	<input type="checkbox" id="borisparam12" name="SiRsv30">
	<label for="borisparam12">RSV_30天</label>
	<input type="checkbox" id="borisparam13" name="SiK5">
	<label for="borisparam13">K_5天</label>
	<input type="checkbox" id="borisparam14" name="SiK30">
	<label for="borisparam14">K_30天</label>
	<input type="checkbox" id="borisparam15" name="SiD5">
	<label for="borisparam15">D_5天</label>
	<input type="checkbox" id="borisparam16" name="SiD30">
	<label for="borisparam16">D_30天</label>
	<input type="checkbox" id="borisparam17" name="SiLongEma">
	<label for="borisparam17">EMA長 (指數移動平均線 - 長期)</label>
	<input type="checkbox" id="borisparam18" name="SiShortEma">
	<label for="borisparam18">EMA短 (指數移動平均線 - 短期)</label>
	<input type="checkbox" id="borisparam19" name="SiDif">
	<label for="borisparam19">DIF (差離值)</label>
	<input type="checkbox" id="borisparam20" name="SiMacd">
	<label for="borisparam20">MACD</label>
	<input type="checkbox" id="borisparam21" name="SiOsc">
	<label for="borisparam21">OSC</label>
	<input type="checkbox" id="borisparam22" name="SiMa">
	<label for="borisparam22">OSC_MA</label>

	<br>
	<h5>基本面:</h5>
	<input type="checkbox" id="borisparam23" name="SbYield">
	<label for="borisparam23">殖利率</label>
	<input type="checkbox" id="borisparam24" name="SbPbratio">
	<label for="borisparam24">淨值比</label>
	<input type="checkbox" id="borisparam25" name="SbEps">
	<label for="borisparam25">EPS</label>
	<input type="checkbox" id="borisparam26" name="SbBussinessIncome">
	<label for="borisparam26">營業收入</label>
	<input type="checkbox" id="borisparam27" name="SiPe">
	<label for="borisparam27">PE (市盈率)</label>
	<br>



	<h5>其餘參數:</h5>
	<input type="checkbox" id="borisparam28" name="ST_Date">
	<label for="borisparam28">日期</label>
	<input type="checkbox" id="borisparam29" name="ST_Year_Quarter">
	<label for="borisparam29">年/季</label>
	<input type="checkbox" id="borisparam30" name="SteDividendYear">
	<label for="borisparam30">最近一筆股利發放年</label>


	<br>
	<h5>使用幾天前的數據進行預測:</h5>
	<input type="radio" id="borisparam31" name="interval" value="5">
	<label for="borisparam31">5天(周)</label>

	<input type="radio" id="borisparam32" name="interval" value="30">
	<label for="borisparam32">30天(月)</label>

	<input type="radio" id="borisparam33" name="interval" value="365">
	<label for="borisparam33">365天(年)</label>
	<br>

	<label>Step1:</label>
	<button id="Okbutton1">確認參數</button>
	<br><br>
	<label>Step2:</label>
	<button id="predict1">建立LSTM模型</button>
	<br>
	<div id="predictionResult1"></div>
	<div class="progress">
		<div class="progress-bar progress-bar-striped progress-bar-animated" id="progress1" role="progressbar"
			 aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
	</div>

</div>
<div id="borisform2">
	<h3>第三步:設定參數並建置模型預測</h3>
	<h4>參數選擇:</h4>
	<h5>技術面:</h5>
	<input type="checkbox" id="borisparam34" name="SteOpen">
	<label for="borisparam34">開盤價</label>
	<input type="checkbox" id="borisparam35" name="SteClose">
	<label for="borisparam35">收盤價</label>
	<input type="checkbox" id="borisparam36" name="SteMax">
	<label for="borisparam36">最高價</label>
	<input type="checkbox" id="borisparam37" name="SteMin">
	<label for="borisparam37">最低價</label>
	<input type="checkbox" id="borisparam38" name="SteSpreadRatio">
	<label for="borisparam38">震幅</label>
	<input type="checkbox" id="borisparam39" name="SteTradeMoney">
	<label for="borisparam39">當日交易額</label>
	<input type="checkbox" id="borisparam40" name="SteTradeQuantity">
	<label for="borisparam40">當日交易量</label>
	<input type="checkbox" id="borisparam41" name="SteTransActions">
	<label for="borisparam41">當日交易比數</label>
	<input type="checkbox" id="borisparam42" name="SiMovingAverage5">
	<label for="borisparam42">移動平均_5天</label>
	<input type="checkbox" id="borisparam43" name="SiMovingAverage30">
	<label for="borisparam43">移動平均_30天</label>
	<input type="checkbox" id="borisparam44" name="SiRsv5">
	<label for="borisparam44">RSV_5天</label>
	<input type="checkbox" id="borisparam45" name="SiRsv30">
	<label for="borisparam45">RSV_30天</label>
	<input type="checkbox" id="borisparam46" name="SiK5">
	<label for="borisparam46">K_5天</label>
	<input type="checkbox" id="borisparam47" name="SiK30">
	<label for="borisparam47">K_30天</label>
	<input type="checkbox" id="borisparam48" name="SiD5">
	<label for="borisparam48">D_5天</label>
	<input type="checkbox" id="borisparam49" name="SiD30">
	<label for="borisparam49">D_30天</label>
	<input type="checkbox" id="borisparam50" name="SiLongEma">
	<label for="borisparam50">EMA長 (指數移動平均線 - 長期)</label>
	<input type="checkbox" id="borisparam51" name="SiShortEma">
	<label for="borisparam51">EMA短 (指數移動平均線 - 短期)</label>
	<input type="checkbox" id="borisparam52" name="SiDif">
	<label for="borisparam52">DIF (差離值)</label>
	<input type="checkbox" id="borisparam53" name="SiMacd">
	<label for="borisparam53">MACD</label>
	<input type="checkbox" id="borisparam54" name="SiOsc">
	<label for="borisparam54">OSC</label>
	<input type="checkbox" id="borisparam55" name="SiMa">
	<label for="borisparam55">OSC_MA</label>


	<br>
	<h5>基本面:</h5>
	<input type="checkbox" id="borisparam56" name="SbYield">
	<label for="borisparam56">殖利率</label>
	<input type="checkbox" id="borisparam57" name="SbPbratio">
	<label for="borisparam57">淨值比</label>
	<input type="checkbox" id="borisparam58" name="SbEps">
	<label for="borisparam58">EPS</label>
	<input type="checkbox" id="borisparam59" name="SbBussinessIncome">
	<label for="borisparam59">營業收入</label>
	<input type="checkbox" id="borisparam60" name="SiPe">
	<label for="borisparam60">PE (市盈率)</label>
	<br>



	<h5>其餘參數:</h5>
	<input type="checkbox" id="borisparam61" name="ST_Date">
	<label for="borisparam61">日期</label>
	<input type="checkbox" id="borisparam62" name="ST_Year_Quarter">
	<label for="borisparam62">年/季</label>
	<input type="checkbox" id="borisparam63" name="SteDividendYear">
	<label for="borisparam63">最近一筆股利發放年</label>


	<br>
	<h5>使用幾天前的數據進行預測:</h5>
	<input type="radio" id="borisparam64" name="interval" value="5">
	<label for="borisparam64">5天(周)</label>

	<input type="radio" id="borisparam65" name="interval" value="30">
	<label for="borisparam65">30天(月)</label>

	<input type="radio" id="borisparam66" name="interval" value="365">
	<label for="borisparam66">365天(年)</label>
	<br>

	<label>Step1:</label>
	<button id="Okbutton2">確認參數</button>
	<br><br>
	<label>Step2:</label>
	<button id="predict2">建立FNN模型</button>
	<br>
	<div id="predictionResult2"></div>
	<div class="progress">
		<div class="progress-bar progress-bar-striped progress-bar-animated" id="progress2" role="progressbar"
			 aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
	</div>
</div>

<div id="kazuoform3">
	<h3>第三步:設定參數並建置模型預測(迴歸模型)</h3>
	<h4>參數選擇:</h4>
	<h5>技術面:</h5>
	<div id="ksParaArea">
		<input type="checkbox" id="kazuopara1" name="SteOpen">
		<label for="kazuopara1">開盤價</label>
		<input type="checkbox" id="kazuopara2" name="SteClose">
		<label for="kazuopara2">收盤價</label>
		<input type="checkbox" id="kazuopara3" name="SteMax">
		<label for="borisparam36">最高價</label>
		<input type="checkbox" id="kazuopara4" name="SteMin">
		<label for="borisparam37">最低價</label>
		<input type="checkbox" id="kazuopara5" name="SteSpreadRatio">
		<label for="borisparam38">震幅</label>
		<input type="checkbox" id="kazuopara6" name="SteTradeMoney">
		<label for="borisparam39">當日交易額</label>
		<input type="checkbox" id="kazuopara7" name="SteTradeQuantity">
		<label for="borisparam40">當日交易量</label>
		<input type="checkbox" id="borisparam41" name="SteTransActions">
		<label for="borisparam41">當日交易比數</label>
		<input type="checkbox" id="borisparam42" name="SiMovingAverage5">
		<label for="borisparam42">移動平均_5天</label>
		<input type="checkbox" id="borisparam43" name="SiMovingAverage30">
		<label for="borisparam43">移動平均_30天</label>
		<input type="checkbox" id="borisparam44" name="SiRsv5">
		<label for="borisparam44">RSV_5天</label>
		<input type="checkbox" id="borisparam45" name="SiRsv30">
		<label for="borisparam45">RSV_30天</label>
		<input type="checkbox" id="borisparam46" name="SiK5">
		<label for="borisparam46">K_5天</label>
		<input type="checkbox" id="borisparam47" name="SiK30">
		<label for="borisparam47">K_30天</label>
		<input type="checkbox" id="borisparam48" name="SiD5">
		<label for="borisparam48">D_5天</label>
		<input type="checkbox" id="borisparam49" name="SiD30">
		<label for="borisparam49">D_30天</label>
		<input type="checkbox" id="borisparam50" name="SiLongEma">
		<label for="borisparam50">EMA長 (指數移動平均線 - 長期)</label>
		<input type="checkbox" id="borisparam51" name="SiShortEma">
		<label for="borisparam51">EMA短 (指數移動平均線 - 短期)</label>
		<input type="checkbox" id="borisparam52" name="SiDif">
		<label for="borisparam52">DIF (差離值)</label>
		<input type="checkbox" id="borisparam53" name="SiMacd">
		<label for="borisparam53">MACD</label>
		<input type="checkbox" id="borisparam54" name="SiOsc">
		<label for="borisparam54">OSC</label>
		<input type="checkbox" id="borisparam55" name="SiMa">
		<label for="borisparam55">OSC_MA</label>


		<br>
		<h5>基本面:</h5>
		<input type="checkbox" id="borisparam56" name="SbYield">
		<label for="borisparam56">殖利率</label>
		<input type="checkbox" id="borisparam57" name="SbPbratio">
		<label for="borisparam57">淨值比</label>
		<input type="checkbox" id="borisparam58" name="SbEps">
		<label for="borisparam58">EPS</label>
		<input type="checkbox" id="borisparam59" name="SbBussinessIncome">
		<label for="borisparam59">營業收入</label>
		<input type="checkbox" id="borisparam60" name="SiPe">
		<label for="borisparam60">PE (市盈率)</label>
		<br>



		<h5>其餘參數:</h5>
		<input type="checkbox" id="borisparam61" name="ST_Date">
		<label for="borisparam61">日期</label>
		<input type="checkbox" id="borisparam62" name="ST_Year_Quarter">
		<label for="borisparam62">年/季</label>
		<input type="checkbox" id="borisparam63" name="SteDividendYear">
		<label for="borisparam63">最近一筆股利發放年</label>
	</div>

	<br>
	<h5>使用幾天前的數據進行預測:</h5>
	<div id="ModelParaInputArea">


	</div>
	<br>

	<label>Step1:</label>
	<button id="ksOkbutton2">確認參數</button>
	<br>
	<br>
	<label>Step2:</label>
	<button id="ksOkbutton3">建立模型</button>
	<br>
	<div id="predictionResult2"></div>
	<div class="progress">
		<div class="progress-bar progress-bar-striped progress-bar-animated" id="progress2" role="progressbar"
			 aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
	</div>
</div>



<script>


	//初始化:不需要的東西先隱藏
	$("#borisform1,#borisform2,#chart").css("display", "none");
	$("#kazuoform3, #kazuoform4").css("display", "none");
	$("#longterm,#shortterm,#predict1,#predict2,#checkmodel,#selectmodel").prop("disabled", true);

	$(document).ready(function () {

		var borisprediction;
		var predicturl;
		var sncode;
		var predictday;
		var userselectparams;
		var functionurl = ["LSTMpredict", "FNNpredict"]
		var prefertype;
		var createmodelTime;
		// <ks area--------------------->
		var InputColumnName = [];
		var InputModelPara = [];
		$("#ksOkbutton2").on("click", function () {

			var ksArea = $(`div#ksParaArea>input[type=checkbox]:checked`);
			$.each(ksArea, function (i, str) {
				InputColumnName.push($(str).attr("name"));

				// console.log($(str).attr("name"));
			})
			var ModelParaInputAreaArea = $(`div#ModelParaInputArea>input`);
			$.each(ModelParaInputAreaArea, function (i, str) {
				InputColumnName.push($(str).attr("name"));

				// console.log($(str).attr("name"));
			})
			console.log(InputColumnName);

		})
		$("#ksOkbutton3").on("click", function () {
		})

		// <ks area--------------------->

		$("#longterm").on("click", function () {
			$("#longterm").css("color", "black")
			$("#shortterm").css("color", "white")
			$("#selectmodel").prop("disabled", false);
			$("#selectmodel option[value='1']").prop("selected", true);
			$("#selectmodel option[value='2']").prop("selected", false);
			$("#selectmodel option[value='3']").prop("selected", true);
			$("#checkmodel").prop("disabled", false);
			$(".progress").hide();
			prefertype = 2;
		})
		$("#shortterm").on("click", function () {
			$("#shortterm").css("color", "black")
			$("#longterm").css("color", "white")
			$("#selectmodel").prop("disabled", false);
			$("#selectmodel option[value='1']").prop("selected", false);
			$("#selectmodel option[value='2']").prop("selected", true);
			$("#selectmodel option[value='3']").prop("selected", false);
			$("#checkmodel").prop("disabled", false);
			$(".progress").hide();
			prefertype = 1;
		})

		$("#checkmodel").on("click", function () {

			if ($("#selectmodel option:selected").length > 1) {
				alert("請選擇一個模型")
			}
			else {
				var choosewhichmodel = $("#selectmodel option:selected").val();
				// $(`#borisform${choosewhichmodel}`).css("display", "block");
				$("#longterm,#shortterm,#checkmodel,#selectmodel").prop("disabled", true);
				var borislist = [];
				switch (choosewhichmodel) {
					case "1":

						$(`#borisform${choosewhichmodel}`).css("display", "block");
						borislist = ["borisparam1", "borisparam2", "borisparam3"];
						$.each(borislist, function (index, element) {
							$(`input[id=${element}]`).prop("checked", true);
						})
						break;
					case "2":

						$(`#borisform${choosewhichmodel}`).css("display", "block");
						borislist = ["borisparam45", "borisparam46", "borisparam47"];
						$.each(borislist, function (index, element) {
							$(`input[id=${element}]`).prop("checked", true);
						});
						break;
					case "3":
						$(`#kazuoform3`).css("display", "block");
						var R_maximumNumberOfIterations = $("<label for='R_maximumNumberOfIterations'>最大迭代數<input id='R_maximumNumberOfIterations' name='R_maximumNumberOfIterations' type ='number' value=100 /></label>");
						$("#ModelParaInputArea").append(R_maximumNumberOfIterations);
						break;
					case "4":
						$(`#kazuoform3`).css("display", "block");
						var windowSize = $("<label for='T_windowSize'>視窗週期(周)<input id='T_windowSize' name='T_windowSize' type ='number' value=100 /></label>");
						var seriesLength = $("<label for='T_seriesLength'>系列週期(月)<input id='T_seriesLength' name='T_seriesLength' type ='number' value=100 /></label>");
						var trainSize = $("<label for='T_trainSize'>訓練資料筆數<input id='T_trainSize' name='T_trainSize' type ='number' value=100 /></label>");
						var confidenceLevel = $("<label for='T_confidenceLevel'>信心水準<input id='T_confidenceLevel' name='T_confidenceLevel' type ='number' value=100 /></label>");
						$("#ModelParaInputArea").append(windowSize);
						$("#ModelParaInputArea").append(seriesLength);
						$("#ModelParaInputArea").append(trainSize);
						$("#ModelParaInputArea").append(confidenceLevel);
						break;
					default:
						break;


				}


			}

		})





		//確定送出參數
		$("#Okbutton1,#Okbutton2").on("click", function (event) {
			var buttonId = $(this).prop("id"); // 獲取按鈕的 ID
			var number = parseInt(buttonId.match(/\d+/)[0]); // 從 ID 中提取數字部分
			sncode = $("#stockid").val();
			predictday = 5;
			userselectparams = {};

			if (number === 1) {
				// 檢查至少兩個參數是否被選中
				const atLeastTwoChecked = $("input[type=checkbox]:checked").length > 1;
				if (!atLeastTwoChecked) {
					alert("請至少選擇2個參數");
					return false;
				}
			} else if (number === 2) {
				// 檢查至少一個參數是否被選中
				const atLeastOneChecked = $("input[type=checkbox]:checked").length > 0;
				if (!atLeastOneChecked) {
					alert("請至少選擇1個參數");
					return false;
				}
			}
			// 檢查區間是否被選擇
			var atLeastoneInterval = $("input[name=interval]:checked").length > 0;
			if (!atLeastoneInterval) {
				alert("請選擇一個區間");
				return false;
			}
			//獲取用戶選擇的預測區間
			var interval = $("input[name=interval]:checked").val();
			if (interval > 0) {
				predictday = parseInt(interval);
			}

			//判斷選取區間是否超過DB有的數字
			$.ajax({
				url: "/StockModel/predictdatacount",
				method: "GET",
				data: { sncode: sncode, predictday: predictday },
				success: function (response) {
					if (response.success === false) {
						alert("股票資料數不夠，請重新選擇區間")
					} else {
						//獲取用戶選擇的參數
						$("input[type=checkbox]:checked").each(function () {
							var paramName = $(this).attr("name");
							userselectparams[paramName] = true;
						});
						$(`#predict${number}`).prop("disabled", false);

					}

				},
				error: function (xhr, status, error) {
					console.error(error);
				}
			});
		});


		$("#predict1,#predict2").on("click", function (event) {
			var buttonId = $(this).prop("id"); // 獲取按鈕的 ID
			var number = parseInt(buttonId.match(/\d+/)[0]); // 從 ID 中提取數字部分
			createmodelTime = new Date();
			$.ajax({
				url: `/StockModel/${functionurl[number - 1]}`,
				type: "Post",
				data: {
					sncode: sncode,
					predictday: predictday,
					selectedParams: userselectparams
				},
				beforeSend: function () {
					$(`#longterm,#shortterm,#predict${number},#Okbutton${number}`).prop("disabled", true);
					// 在發送請求前顯示訓練中的訊息
					$(`#predictionResult${number}`).text("模型訓練中...");
					$(`.progress`).show()
					var progress = 0; // 初始化進度
					var increaseProgress = function () {
						if (progress <= 80) {
							progress += 10; // 每次增加 10%
							$(`#progress${number}`).css("width", progress + "%");
							setTimeout(increaseProgress, 800);
						}
					};
					increaseProgress(); // 開始增加進度
				},

				success: function (rep) {
					$(`#progress${number}`).css("width", '100%');

					setTimeout(function () {
						$(`.progress`).hide();
					}, 1000);

					borisprediction = parseFloat(rep);
					if (borisprediction < 0) {
						borisprediction = -borisprediction;
					}
					borisprediction = borisprediction.toFixed(2);



					//存數據
					var isoString = createmodelTime.toISOString();
					var keysWithoutBrackets = Object.keys(userselectparams).map(function (key) {
						return key;
					}).join(",");
					console.log(borisprediction)
					var datatoserver = {
						PStock: sncode,
						PVariable: keysWithoutBrackets,
						PLabel: borisprediction,
						PPrefer: prefertype,
						PBuildTime: isoString

					}

					$.ajax({
						method: "Post",
						url: "StockModel/Predictsavedata",
						data: datatoserver,
						success: function (e) {
							alert("save OK")
						},
						error: function (xhr, status, error) {
							// 處理錯誤
							console.error(xhr.responseText); // 處理錯誤
							var errorMessage = xhr.responseText;
							alert(errorMessage);
						}
					})
					console.log(borisprediction)
					var predictedData = borisprediction;




					// 在這裡將 predictedData 傳遞到 predictphoto 頁面
					predicturl = "/StockModel/predictphoto?predictedData=" + predictedData + "&snCode=" + sncode;

					//跳轉
					window.location.href = predicturl

				},
				error: function (xhr, status, error) {
					// 處理錯誤
					console.error('Error occurred: ' + error); // 處理錯誤
					var errorMessage = xhr.responseText;
					alert(errorMessage);
					$(`#predictionResult${number}`).text("");
				}
			});
		});






	});
	function stockinput() {
		var stockId = $("#stockid").val();
		$("#stockname").text("");
		if (stockId.trim() !== "") {
			$.get("/StockModel/checkstock", { sncode: stockId },
				function (element) {
					if (element.stockexist) {
						$("#longterm,#shortterm").prop("disabled", false);
						$("#stockname").text(element.stockname);
					} else {
						alert("請選擇其他股票");
						$("#longterm,#shortterm").prop("disabled", true);
					}
				}
			);
		}
	}
</script>